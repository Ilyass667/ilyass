def read_temp_loop():
    def loop():
        global temp_value, current_humidity
        while True:
            if not test_mode_active:
                # Réintroduire la boucle de réessai du capteur
                for _ in range(15):  # <-- Ajouter cette ligne
                    chk = dht.readDHT11()
                    if chk == 0:
                        real_temp = dht.getTemperature()
                        real_humidity = dht.getHumidity()
                        timestamp = datetime.now().isoformat()

                        try:
                            # Insertion MySQL
                            sql = "INSERT INTO sensor_data (temperature, humidity) VALUES (?, ?)"
                            val = (real_temp, real_humidity)
                            mysql_cursor.execute(sql, val)
                            mysql_db.commit()

                            # Envoi à Firebase
                            ref = db.reference('donnees').push({
                                'temperature': real_temp,
                                'humidity': real_humidity,
                                'timestamp': timestamp
                            })
                            
                            # Mise à jour interface
                            temp_value = real_temp
                            current_humidity = real_humidity
                            window.after(0, update_display)
                            print(f"Données sauvegardées (Temp: {real_temp}°C")
                            break  # Sortir de la boucle après succès

                        except Exception as e:
                            print(f"Erreur: {e}")
                            break

                    time.sleep(2)  # Intervalle de réessai réduit
                else:
                    print("Échec lecture capteur après 15 tentatives")
            
            time.sleep(15)  # Intervalle principal inchangé

    threading.Thread(target=loop, daemon=True).start()
